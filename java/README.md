# Installation

* To install the Java code, do `mvn install` from the root of this repository using Apache Maven.
Repeat this if you pull an updated version of the code. You can run the tests,
which should output the examples, by doing `mvn test`.
* To install the Python code, do `python setup.py install` from the root of
  this repository.

# Using the AIF Library

To use the library in Java, include the library generated by the
installation above into your build script or tool.  For gradle, for
example, include the following in the dependencies in your `build.gradle` file:

`dependencies {
    compile 'com.ncc:aida-interchange:1.1.0-SNAPSHOT'
}`

In your code, import classes from the `com.ncc.aif` package.
Then, create a model, add entities, relations, and events to the
model, and then write the model out.

The file `src/test/java/com/ncc/aif/ExamplesAndValidationTests.java`
has a series of examples showing how to add things to the model.  The
`src/text/java/com/ncc/aif/ScalingTest.java` file has examples of how
to write the model out.

# The AIF Validator
The AIF validator is an extension of the validator written by Ryan Gabbard (USC ISI)
and converted to Java by Next Century.  This version of the validator accepts multiple
ontology files, can validate against NIST requirements (restricted AIF), and can
validate N files or all files in a specified directory.

### Running the AIF validator
To run the validator from the command line, run `target/appassembler/bin/validateAIF`
with a series of command-line arguments (in any order) honoring the following usage:  <br>
Usage:  <br>
`validateAIF [-hov] [--ldc] [--nist] [--nist-ta3] [--pm] [--program] [--abort[=num]] [--depth[=num]] [-d=DIRNAME] [-t=num] [--ont=FILE...]... [-f=FILE...]...`  <br>

| Switch | Description |
| ----------- | ----------- |
|`--ldc`    | validate against the LDC ontology |
|`--program`| validate against the program ontology |
|`--ont=FILE ...` | validate against the OWL-formatted ontolog(ies) at the specified filename(s) |
|`--nist` | validate against the NIST restrictions |
|`--nist-ta3` | validate against the NIST hypothesis restrictions (implies `--nist`) |
|`--abort[=num]` | Abort validation after `[num]` SHACL violations (num > 2), or three violations if `[num]` is omitted. |
|`--depth[=num]` | Perform shallow validation in which each SHACL rule (shape) is only applied to `[num]` target nodes, or 50 nodes if `[num]` is omitted (requires -t). |
|`--pm` | Enable progress monitor that shows ongoing validation progress.  If `-t` is specified, then thread metrics are provided post-validation instead. |
|`--disk` | Use disk-based model for validating very large files |
|`-o` | Save validation report model to a file. `KB.ttl` results will be saved to KB-report*.txt, up to 1 report per thread. Output defaults to stderr. |
|`-t=num` | Specify the number of threads to use during validation. If the `--pm` option is specified, thread metrics are provided post-validation instead. |
|`-d=DIRNAME` | validate all `.ttl` files in the specified directory |
|`-f=FILE ...` | validate the specified file(s) with a `.ttl` suffix |
|`-h, --help` | This help and usage text |
|`-v, --version` | Print the validator version |

Either a file (-f) or a directory (-d) must be specified (but not both).  <br>
Exactly one of --ldc, --program, or --ont must be specified.  <br>
Ontology files can be found in `src/main/resources/com/ncc/aif/ontologies`:
- LDC (LO): `LDCOntology`
- Program (AO): `EntityOntology`, `EventOntology`, `RelationOntology`

### Validator return values
Return values from the command-line validator are as follows:
* `0 (Success)`.  There were no validation (or any other) errors.
* `1 (Validation Error)`.	All specified files were validated but at least one failed validation.  Supersedes a File Error.
* `2 (Usage Error)`.  There was a problem interpreting command-line arguments.  No validation was performed.
* `3 (File Error)`.  A file was rejected or couldn't be validated, either due to an I/O error, a validation engine error,
  or because it didn't meet certain criteria.  Logging indicates the nature of the problem(s).  Validation may
  have been performed on a subset of specified KBs.  If there is an error loading any ontologies or SHACL files,
  then no validation is performed.

### Running the validator in code
To run the validator programmatically in Java code, first use one of the public `ValidateAIF.createXXX()`
methods to create a validator object, then call one of the public `validateKB()` methods.
`createForLDCOntology()` and `createForProgramOntology()` are convenience wrappers for `create()`, which
is flexible enough to take a Set of ontologies.  All creation methods accept a flag for validating
against restricted AIF; see the JavaDocs.  Note that the original `ValidateAIF.createForDomainOntologySource()` method
remains for backward compatibility.

Once the validator has been initialized, there are several APIs to validate KBs and retrieve results.  `validateKB()`
simply returns whether or not the KB is valid.  If you want any information about why the KB was invalid, use one of
the `validateKBAndReturnXXX()` methods.  Results can be returned as multiple error reports, or as one combined report,
but note that for some validations, particularly large files with many violations, combining reports could incur
significant overhead. 

### Failing fast

The AIF Validator can be told to "fail fast," that is, exit as soon as a few SHACL violations are found in
the specified KB.  On the command-line, use the `--abort` option to have the validator exit after three
violations.  Specify a number after the `--abort` flag to exit after that number of violations.  The validation
summary will display the number of aborted validations-- but if your file has the exact number of violations as
the threshold, it will still be counted as an aborted validation.

**NOTE**: As of this writing, if you set the threshold too low (less than 3), the validator might erroneously return
that your KB is *valid*.  This appears to be a current bug or limitation in the TopBraid shacl library snapshot.
Consequently, the command-line validator will reject thresholds less than 3.

Without the `--abort` option, the entire KB will be validated with full output of all violations.

To fail fast when using the validator programmatically, use `ValidateAIF.setAbortThreshold()` to set an error
threshold.

### Shallow validation

The `--depth` option performs a "shallow" validation in which each SHACL rule (shape) only considers a subset of its
target nodes.  The size of this subset (i.e., the depth of the validation) can be specified on the command line.
For example, `--depth=100` means that if your file has 30,000 event arguments, then the `aida:EventArgumentShape` will
only be applied to 100 event arguments, significantly speeding up generation of an error report.  Any violations in
these 100 nodes will be included in the error report.  By default (if no depth is specified), only 50 target nodes will
be tested.  The `--depth` option requires enabling the multi-threaded validator via the `-t` option.
Unlike failing fast, shallow validation ends early whether or not it finds any SHACL violations.

To enable shallow validation programmatically, use `ValidateAIF.setDepth()` and specify a depth.

### Memory considerations

Validation of a large files can require significant system resources, particularly system RAM.  By default, the Java
heap will use up to half of the available RAM on your system.  If you want to set a higher (or lower) maximum, then
set the `JAVA_OPTS` environment variable to, for example, `-Xmx16G` to use up to 16GB of RAM.

Alternatively, you can add `<extraJvmArguments>-Xmx16G</extraJvmArguments>` to your `pom.xml` file in the
`<configuration>` block of the `appassembler-maven-plugin` plugin.

# Running the Ontology Resource Generator

To generate the resource variables from a particular ontology file, please refer to
the README located at `src/main/java/com/ncc/aif/ont2javagen/README.md`.

# Additional Information about Individual Ontologies

There is another README located at `src/main/resources/com/ncc/aif/ontologies/README.md` that gives a description about each of the ontology files currently available in AIF.

# Developing

If you need to edit the Java code:
 1. Install IntelliJ IDEA.
 2. "Import Project from Existing Sources"
 3. Choose the `pom.xml` for this repository and accept all defaults.

You should now be ready to go.

# Documentation

To generate the javadoc documentation, navigate to the top level directory in the AIDA-Interchange-Format project. Run the following command:

```bash
$ javadoc -d build/docs/javadoc/ src/main/java/com/ncc/aif/*.java
```
This script will generate documentation in the form of HTML and place it within the `build/docs/javadoc` folder.
